"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.7.22"
__checksum__ = "a5a97e40ae03a4578cae4b97e27b7abd0681b057d373576bedb44ce4c8956b8a"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 11), (141, 7), (148, 20), (168, 18), None, (186, 22), (208, 45), (253, 7), (260, 9), (269, 36), (305, 10), (315, 10), (325, 21), None, (346, 50), (396, 8), (404, 9), (413, 19), (432, 13), (445, 14), (459, 14), None, None, (473, 29), (502, 16), (518, 35), (553, 14), (567, 24), (591, 9), None, (600, 25), (625, 20), (645, 8), (653, 13), (666, 10), None, (676, 11), (687, 6), (693, 26), (719, 5), (724, 5), (729, 10), (739, 10), (749, 11), (760, 12), (772, 27), None, (799, 11), (810, 11), (821, 7), (828, 29), (857, 18), (875, 27), (902, 46), (948, 25), (973, 16), (989, 8), (997, 5), (1002, 22), (1024, 18), None, (1042, 36), (1078, 15), (1093, 8), (1101, 5), None, (1106, 5), (1111, 16), (1127, 14), (1141, 18), None, (1159, 14), (1173, 18), (1191, 48), (1239, 19), (1258, 5), (1263, 46), (1309, 14), (1323, 14), (1337, 20), None, (1357, 10), (1367, 13), (1380, 10), (1390, 19), None, (1409, 13), (1422, 19), (1441, 5), (1446, 4), (1450, 22), (1472, 10), (1482, 7), (1489, 14), (1503, 21), (1524, 11), (1535, 10), (1545, 12), (1557, 32), None, (1589, 10), (1599, 14), (1613, 12), (1625, 45), (1670, 15), None, (1685, 11), (1696, 23), (1719, 21), (1740, 26), (1766, 6), (1772, 6), (1778, 7), (1785, 5), (1790, 20), (1810, 23), (1833, 24), (1857, 13), (1870, 15), (1885, 19), (1904, 6), (1910, 61), (1971, 44), (2015, 12), (2027, 23), (2050, 16), (2066, 38), (2104, 6), (2110, 12), (2122, 44), (2166, 6), (2172, 41), (2213, 13), (2226, 23), (2249, 30), (2279, 16), (2295, 8), (2303, 6), (2309, 12), (2321, 19), (2340, 21), (2361, 15), None, (2376, 35), (2411, 21), (2432, 17), (2449, 19), (2468, 26), (2494, 5), (2499, 37), (2536, 30), (2566, 16), (2582, 10), (2592, 17), (2609, 23), (2632, 14), (2646, 17), (2663, 8), (2671, 4), (2675, 7), (2682, 29), (2711, 6), (2717, 18), (2735, 27), (2762, 20), (2782, 17), (2799, 19), (2818, 12), (2830, 40), (2870, 40), (2910, 12), (2922, 48), (2970, 25), (2995, 12), None, (3007, 8), (3015, 20), (3035, 19), (3054, 6), (3060, 23), None, (3083, 23), (3106, 33), (3139, 14), (3153, 12), (3165, 27), None, (3192, 26), (3218, 31), (3249, 50), (3299, 15), (3314, 20), (3334, 15), (3349, 21), (3370, 32), (3402, 24), (3426, 20), (3446, 13), (3459, 60), (3519, 19), (3538, 9), (3547, 12), (3559, 12), (3571, 11), (3582, 10), (3592, 48), (3640, 32), None, (3672, 25), (3697, 12), None, (3709, 8), (3717, 8), (3725, 7), None, (3732, 25), (3757, 17), None, (3774, 21), (3795, 35), (3830, 12), (3842, 10), (3852, 36), (3888, 20), (3908, 22), (3930, 23), (3953, 19), (3972, 12), (3984, 5), (3989, 30), (4019, 24), (4043, 14), (4057, 14), (4071, 47), (4118, 46), None, None, (4164, 51), (4215, 42), None, (4257, 14), None, (4271, 15), (4286, 8), (4294, 21), (4315, 6), (4321, 16), (4337, 17)], [(4354, 6057), (10411, 6518), (16929, 6989), (23918, 5809), (29727, 6198), (35925, 5862), (41787, 6837), (48624, 6092), (54716, 6645), (61361, 5901), (67262, 6968), (74230, 6268), (80498, 6621), (87119, 6977), (94096, 6451), (100547, 6351), (106898, 6952), (113850, 5870), (119720, 6168), (125888, 6477), (132365, 6754), (139119, 6472), (145591, 6768), (152359, 6033), (158392, 6098), (164490, 6560), (171050, 6445), (177495, 6698), (184193, 6176), (190369, 6448), (196817, 6755), (203572, 6347), (209919, 6325), (216244, 6925), (223169, 6027), (229196, 6713), (235909, 6164), (242073, 6895), (248968, 6611), (255579, 6915), (262494, 7352), (269846, 6266), (276112, 6206), (282318, 6042), (288360, 6240), (294600, 5976), (300576, 6149), (306725, 6927), (313652, 6264), (319916, 5591), (325507, 6374), (331881, 6493), (338374, 6397), (344771, 6664), (351435, 6727), (358162, 6597), (364759, 6699), (371458, 5767), (377225, 6680), (383905, 5723), (389628, 6504), (396132, 6294), (402426, 6212), (408638, 6711), (415349, 6583), (421932, 6428), (428360, 6028), (434388, 6942), (441330, 6585), (447915, 6726), (454641, 6314), (460955, 6327), (467282, 5634), (472916, 6913), (479829, 6898), (486727, 6778), (493505, 6014), (499519, 7106), (506625, 6918), (513543, 5971), (519514, 6580), (526094, 5658), (531752, 6280), (538032, 6477), (544509, 6380), (550889, 6316), (557205, 6483), (563688, 6602), (570290, 6624), (576914, 6361), (583275, 7111), (590386, 5938), (596324, 6106), (602430, 6444), (608874, 6411), (615285, 6974), (622259, 6746), (629005, 6292), (635297, 6170), (641467, 6039), (647506, 6147), (653653, 6711), (660364, 6117), (666481, 6369), (672850, 6020), (678870, 6740), (685610, 6523), (692133, 6890), (699023, 7890), (706913, 6990), (713903, 6823), (720726, 6377), (727103, 6162), (733265, 6599), (739864, 6805), (746669, 6381), (753050, 6150), (759200, 6311), (765511, 6297), (771808, 6792), (778600, 6630), (785230, 6749), (791979, 6961), (798940, 6712), (805652, 7665), (813317, 6303), (819620, 5654), (825274, 6808), (832082, 6499), (838581, 7853), (846434, 6834), (853268, 6088), (859356, 6660), (866016, 6756), (872772, 6274), (879046, 6649), (885695, 6047), (891742, 6663), (898405, 6334), (904739, 6415), (911154, 6425), (917579, 7118), (924697, 6097), (930794, 6173), (936967, 6475), (943442, 6401), (949843, 6350), (956193, 6698), (962891, 6058), (968949, 7013), (975962, 6559), (982521, 6671), (989192, 6754), (995946, 6378), (1002324, 6410), (1008734, 6330), (1015064, 6268), (1021332, 6229), (1027561, 6101), (1033662, 5660), (1039322, 6016), (1045338, 6496), (1051834, 7113), (1058947, 5993), (1064940, 6520), (1071460, 6845), (1078305, 6284), (1084589, 6068), (1090657, 6703), (1097360, 6360), (1103720, 5863), (1109583, 6434), (1116017, 7506), (1123523, 5950), (1129473, 6063), (1135536, 6584), (1142120, 6121), (1148241, 6613), (1154854, 6222), (1161076, 5944), (1167020, 7291), (1174311, 6630), (1180941, 6303), (1187244, 6906), (1194150, 7191), (1201341, 7223), (1208564, 6134), (1214698, 6860), (1221558, 6201), (1227759, 6505), (1234264, 6664), (1240928, 6001), (1246929, 6768), (1253697, 6845), (1260542, 6453), (1266995, 6426), (1273421, 6211), (1279632, 6407), (1286039, 6653), (1292692, 6204), (1298896, 6515), (1305411, 5814), (1311225, 7035), (1318260, 6878), (1325138, 6557), (1331695, 6788), (1338483, 5596), (1344079, 6554), (1350633, 6360), (1356993, 6514), (1363507, 6731), (1370238, 7021), (1377259, 6465), (1383724, 6578), (1390302, 6691), (1396993, 6319), (1403312, 6412), (1409724, 6423), (1416147, 6467), (1422614, 6198), (1428812, 6329), (1435141, 5886), (1441027, 7355), (1448382, 6522), (1454904, 6250), (1461154, 6647), (1467801, 6536), (1474337, 5708), (1480045, 6581), (1486626, 6440), (1493066, 7499), (1500565, 6324), (1506889, 5751), (1512640, 6886), (1519526, 6310), (1525836, 6934), (1532770, 6035), (1538805, 6122), (1544927, 5779), (1550706, 6591), (1557297, 6433), (1563730, 6782), (1570512, 6121), (1576633, 6519), (1583152, 6339), (1589491, 6909), (1596400, 6270), (1602670, 5747), (1608417, 6450), (1614867, 6086), (1620953, 6540), (1627493, 6744), (1634237, 7053), (1641290, 6214), (1647504, 6211), (1653715, 6560)], [(1660275, 703), (1660978, 625), (1661603, 628), (1662231, 663), (1662894, 523), (1663417, 611), (1664028, 644), (1664672, 808), (1665480, 640), (1666120, 627), (1666747, 509), (1667256, 544), (1667800, 758), (1668558, 866), (1669424, 936), (1670360, 714), (1671074, 1207), (1672281, 606), (1672887, 875), (1673762, 673), (1674435, 733), (1675168, 708), (1675876, 802), (1676678, 709), (1677387, 684), (1678071, 631), (1678702, 940), (1679642, 1056), (1680698, 791), (1681489, 657), (1682146, 896), (1683042, 728), (1683770, 557), (1684327, 671), (1684998, 732), (1685730, 761), (1686491, 619), (1687110, 688), (1687798, 692), (1688490, 992), (1689482, 683), (1690165, 812), (1690977, 660), (1691637, 689), (1692326, 728), (1693054, 362), (1693416, 763), (1694179, 857), (1695036, 673), (1695709, 525), (1696234, 789), (1697023, 633), (1697656, 763), (1698419, 935), (1699354, 918), (1700272, 483), (1700755, 661), (1701416, 486), (1701902, 578), (1702480, 724), (1703204, 734), (1703938, 753), (1704691, 1008), (1705699, 836), (1706535, 602), (1707137, 692), (1707829, 767), (1708596, 444), (1709040, 561), (1709601, 487), (1710088, 692), (1710780, 802), (1711582, 540), (1712122, 725), (1712847, 634), (1713481, 671), (1714152, 552), (1714704, 680), (1715384, 768), (1716152, 428), (1716580, 672), (1717252, 629), (1717881, 828), (1718709, 623), (1719332, 588), (1719920, 282), (1720202, 597), (1720799, 725), (1721524, 756), (1722280, 663), (1722943, 816), (1723759, 1074), (1724833, 788), (1725621, 773), (1726394, 674), (1727068, 436), (1727504, 938), (1728442, 858), (1729300, 564), (1729864, 580), (1730444, 666), (1731110, 843), (1731953, 839), (1732792, 552), (1733344, 632), (1733976, 697), (1734673, 363), (1735036, 467), (1735503, 924), (1736427, 863), (1737290, 792), (1738082, 774), (1738856, 610), (1739466, 771), (1740237, 643), (1740880, 683), (1741563, 689), (1742252, 433), (1742685, 639), (1743324, 588), (1743912, 914), (1744826, 653), (1745479, 789), (1746268, 404), (1746672, 703), (1747375, 656), (1748031, 835), (1748866, 883), (1749749, 766), (1750515, 904), (1751419, 747), (1752166, 524), (1752690, 757), (1753447, 583), (1754030, 737), (1754767, 732), (1755499, 639), (1756138, 682), (1756820, 589), (1757409, 640), (1758049, 594), (1758643, 691), (1759334, 691), (1760025, 637), (1760662, 437), (1761099, 549), (1761648, 641), (1762289, 556), (1762845, 683), (1763528, 594), (1764122, 761), (1764883, 520), (1765403, 490), (1765893, 656), (1766549, 573), (1767122, 607), (1767729, 639), (1768368, 796), (1769164, 594), (1769758, 609), (1770367, 841), (1771208, 826), (1772034, 522), (1772556, 695), (1773251, 796), (1774047, 587), (1774634, 659), (1775293, 480), (1775773, 609), (1776382, 621), (1777003, 714), (1777717, 598), (1778315, 898), (1779213, 695), (1779908, 794), (1780702, 701), (1781403, 649), (1782052, 566), (1782618, 646), (1783264, 699), (1783963, 1277), (1785240, 514), (1785754, 624), (1786378, 608), (1786986, 962), (1787948, 754), (1788702, 745), (1789447, 546), (1789993, 565), (1790558, 808), (1791366, 553), (1791919, 569), (1792488, 826), (1793314, 650), (1793964, 871), (1794835, 772), (1795607, 668), (1796275, 671), (1796946, 783), (1797729, 620), (1798349, 889), (1799238, 631), (1799869, 722), (1800591, 558), (1801149, 689), (1801838, 449), (1802287, 775), (1803062, 779), (1803841, 648), (1804489, 901), (1805390, 775), (1806165, 759), (1806924, 903), (1807827, 1077), (1808904, 815), (1809719, 586), (1810305, 839), (1811144, 662), (1811806, 483), (1812289, 443), (1812732, 692), (1813424, 749), (1814173, 406), (1814579, 974), (1815553, 462), (1816015, 758), (1816773, 863), (1817636, 712), (1818348, 769), (1819117, 626), (1819743, 743), (1820486, 665), (1821151, 753), (1821904, 566), (1822470, 566), (1823036, 408), (1823444, 601), (1824045, 437), (1824482, 740), (1825222, 815), (1826037, 764), (1826801, 718), (1827519, 621), (1828140, 568), (1828708, 848), (1829556, 440), (1829996, 573), (1830569, 780), (1831349, 513), (1831862, 824), (1832686, 2071), (1834757, 527), (1835284, 602), (1835886, 875), (1836761, 851), (1837612, 510)], [(1838122, 48), None, (1838170, 35), (1838205, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1838247, 42), None, (1838289, 25), (1838314, 16), None, None, None, None, None, None, (1838330, 26), None, None, None, None, (1838356, 21), (1838377, 25), None, None, (1838402, 26), None, None, None, None, (1838428, 44), (1838472, 21), (1838493, 23), None, None, None, None, (1838516, 48), None, None, None, None, None, (1838564, 31), None, None, None, None, (1838595, 42), None, (1838637, 22), None, (1838659, 21), None, (1838680, 26), (1838706, 42), None, None, (1838748, 77), None, None, None, None, None, (1838825, 21), (1838846, 21), None, None, (1838867, 34), (1838901, 42), None, None, None, (1838943, 25), None, None, (1838968, 21), None, None, None, None, None, (1838989, 24), (1839013, 21), None, None, (1839034, 26), None, (1839060, 18), None, (1839078, 54), None, None, None, None, None, None, (1839132, 26), None, (1839158, 19), None, (1839177, 20), None, None, (1839197, 42), (1839239, 42), (1839281, 17), None, (1839298, 26), None, (1839324, 26), None, None, None, (1839350, 26), (1839376, 20), (1839396, 26), None, (1839422, 42), (1839464, 63), None, None, None, (1839527, 40), (1839567, 48), None, None, None, (1839615, 47), None, None, None, None, None, None, None, (1839662, 42), None, (1839704, 55), None, (1839759, 9), None, (1839768, 21), (1839789, 42), None, None, (1839831, 42), (1839873, 82), None, None, (1839955, 42), None, None, None, None, None, None, None, None, None, (1839997, 42), (1840039, 21), (1840060, 21), None, (1840081, 42), (1840123, 25), None, None, (1840148, 21), (1840169, 42), None, None, (1840211, 21), (1840232, 19), (1840251, 26), None, None, None, (1840277, 21), None, None, (1840298, 38), None, (1840336, 22), (1840358, 21), (1840379, 21), None, None, (1840400, 63), None, (1840463, 21), (1840484, 42), None, (1840526, 17), None, None, None, None, (1840543, 21), (1840564, 21), None, None, (1840585, 21), None, None, (1840606, 21), None, (1840627, 26), None, (1840653, 50), None, None, None, (1840703, 50), (1840753, 26), (1840779, 21), (1840800, 21), (1840821, 19), None, (1840840, 35), (1840875, 26), (1840901, 23), (1840924, 21), (1840945, 42), None, None, None, None, None, None, (1840987, 21), None, None, None, (1841008, 21), None, None, (1841029, 90), None, (1841119, 239), (1841358, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path), "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
